# CI profile configuration
# Activate with: spring.profiles.active=ci
# This profile is used during CI/CD pipeline smoke tests

spring:
  datasource:
    # Explicitly set database URL for CI (required)
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://postgres:5432/crypto_exchange}
    username: ${SPRING_DATASOURCE_USERNAME:${POSTGRES_USER:-postgres}}
    password: ${SPRING_DATASOURCE_PASSWORD:${POSTGRES_PASSWORD:-postgres}}
    driver-class-name: org.postgresql.Driver
  
  jpa:
    hibernate:
      ddl-auto: validate
    # Explicitly set dialect to avoid connection issues during initialization
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
    # Disable JPA schema initialization - Flyway handles it
    defer-datasource-initialization: false
  
  # Ensure Flyway runs migrations in CI before Hibernate validation
  # Flyway runs automatically before JPA initialization in Spring Boot
  flyway:
    enabled: true
    baseline-on-migrate: true
    baseline-version: 0
    locations: classpath:db/migration
    validate-on-migrate: true
    clean-disabled: true
    # Enable debug logging for Flyway
    out-of-order: false

management:
  endpoint:
    health:
      show-details: always  # Show detailed health info in CI for debugging
  endpoints:
    web:
      exposure:
        include: health,info

# Override any production security settings if needed
# Note: SecurityConfig already allows public access to /actuator/health
# This profile ensures actuator endpoints are accessible during CI
